# Настройка соединения Pelican Mini - COEX Control Module

## Запись образа

1. Загрузите последние образы [NavTALink](https://github.com/CopterExpress/navtalink-ci-images/releases) для коптера и [NavTALink control](https://github.com/CopterExpress/navtalink-control-ci-images/releases) для пульта.

2. Запишите образ NavTALink на MicroSD карту и установите в Raspberry Pi на дроне.

    > **Info** Для записи можно использовать приложение [*balenaEtcher*](https://www.balena.io/etcher/).

3. Запишите образ NavTALink control на MicroSD и установите в Raspberry Pi в пульте.

## Инициализация образа пульта COEX Control Module

1. Включите Raspberry Pi пульта. При первом включении появится надпись *Setting up file system*. Дождитесь окончания настройки, после чего выключите пульт.

2. Включите пульт повторно, на экране появится консольный вывод конфигурации системы, дождитесь окончания конфигурации, после чего выключите пульт.

3. Еще раз включите пульт, теперь после загрузки системы, откроется рабочий стол и автоматически запустится приложение QGroundControl.

4. Выключите пульт и вытащите из него MicroSD карту с образом.

## Настройка образа дрона Pelican Mini

1. Включите Raspberry Pi дрона. После инициализации образа появится WiFi сеть с именем *NavTALink-XXXX* подключитесь к ней, стандартный пароль *navtalinkwifi*.

2. Подключитесь к системе по IP: `192.168.30.1`. Для подключения используйте любой SSH клиент. Пошаговую инструкцию о подключении с помощью Windows можно прочитать [тут](http://pelican.coex.tech/ru/latest/navtalink_setup/#putty).

3. Сгенерируйте ключи шифрования используя команду:

    ```bash
    wfb_keygen
    ```

4. В результате выполнения команды, в домашней директории `/home/pi/` появятся 2 файла ключей `gs.key` и `drone.key`, для станции управления и дрона соответственно.

5. Перейдите в домашнюю директорию и перенесите ключ шифрования дрона `drone.key` в директорию `/etc/` командой:

    ```bash
    cd ~/
    sudo cp grone.key /etc/
    ```

6. Вызовите команду записи идентификационного номера сетевого адаптера:

    ```bash
    sudo navtalink_update_adapter
    ```

7. Вызовите команду запуска всех необходимых служб дрона:

    ```bash
    sudo navtalink_set_role drone
    ```

8. Включите автозапуск сервиса управления модулем DuoCam:

    ```bash
    sudo systemctl enable duocam-camera.service
    ```

9. Загрузите ключ шифрования станции управления `gs.key` на компьютер. Для этого используйте любой SFTP клиент или сделайте это вручную, подключив MicroSD карточку к компьютеру.

10. Удалите ключи шифрования оставшиеся на дроне:

    ```bash
    rm gs.key
    ```

## Настройка образа пульта COEX Control Module

1. Подключите MicroSD карточку пульта к компьютеру и перенесите ключ `gs.key` в директорию `etc/`.

2. Установите MicroSD карточку обратно в пульт и включите его.

3. Вызовите команду записи идентификационного номера сетевого адаптера:

    ```bash
    sudo navtalink_update_adapter
    ```

4. Вызовите команду запуска всех необходимых служб пульта:

    ```bash
    sudo navtalink_set_role gs
    ```

5. Откройте окно QGroundControl и зайдите в окно *General*.

#TODO

6. Во вкладке *Video stream* выберите значение *h264* и установите порт 5600.

## Настройка полетного контроллера

Скачайте последнюю версию прошивки *charging_station_1.9.2*, в репозитории https://github.com/CopterExpress/Firmware.

Последний выпущенный релиз [*v1.9.2-charging-station.4*](https://github.com/CopterExpress/Firmware/tree/v1.9.2-charging-station.4).

1. Установите прошивку на дрон.

#TODO

2. Во вкладке *Parameters* найдите параметр *TELEM1* и установите скорость передачи 56400.
